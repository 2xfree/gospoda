#include <stdio.h>
#include <ctype.h>
#include <string.h>
#include <time.h>
#include <stdlib.h>
#include <unistd.h>

struct combatant
{
    char name[16];
    int class;
    int age;
    char *background;
};

void createCombatant(struct combatant *combatant);
void battle(struct combatant *combatant1, struct combatant *combatant2);
void trueWinner();

int main(int argc, char const *argv[])
{
    struct combatant *combatant1;
    struct combatant *combatant2;
    combatant1 = (struct combatant *)malloc(sizeof(struct combatant));
    combatant1->background = (char *)malloc(64);
    combatant2 = (struct combatant *)malloc(sizeof(struct combatant));
    combatant2->background = (char *)malloc(64);

    puts("TODO");
    fflush(stdout);
    sleep(1);
    puts("Napravite prvog borca!");
    createCombatant(combatant1);
    puts("Prvi borac napravljen. Sada drugi...");
    createCombatant(combatant2);
    puts("Drugi borac napravljen!");

    battle(combatant1, combatant2);

    return 0;
}

void createCombatant(struct combatant *combatant)
{
    fputs("Ime (max. 15 znakova): ", stdout);
    scanf("%15s",combatant->name);
    int redo;
    do
    {
        redo = 0;
        fputs("Odaberite klasu:\n1) Vitez\n2) Carobnjak\n3) Strijelac\n> ", stdout);
        char class[10];
        scanf("%9s",class);
        for (int i = 0; class[i]; i++)
            *class = tolower(*class);
        if (strcmp("vitez", class) == 0)
            combatant->class = 0;
        else if (strcmp("carobnjak", class) == 0)
            combatant->class = 1;
        else if (strcmp("strijelac", class) == 0)
            combatant->class = 2;
        else
        {
            puts("Klasa ne postoji, pokuÅ¡ajte ponovno...");
            sleep(1);
            redo = 1;
        }
    } while (redo == 1);
    fputs("Dob: ", stdout);
    scanf("%d",&combatant->age);
    fputs("Biografija: ",stdout);
    scanf("%150s",combatant->background);
}

void battle(struct combatant *combatant1, struct combatant *combatant2)
{
    puts("Bitka zapocinje.");
    sleep(1);
    puts("Chin, pft, plow...");
    fflush(stdout);
    sleep(1);
    srand(time(NULL));
    int winner = rand() % 2;
    struct combatant *victor;
    if (winner == 0)
        victor = combatant1;
    else
        victor = combatant2;
    printf("Bitka je bila duga i teska, ali na vrhu jest ostao %s\n\n", victor->name);

    char picture[1000];
    FILE *f;
    if (victor->class == 0)
        f = fopen("./knight", "r");
    else if (victor->class == 1)
        f = fopen("./wizard", "r");
    else
        f = fopen("./archer", "r");

    
    for(int i = 0;!feof(f);i++) {
        picture[i]=fgetc(f);
    }
    fclose(f);
    puts(picture);
}

void trueWinner(){
    FILE *f;
    f = fopen("./flag.txt","r");
    char flag[100];
    fgets(flag,100,f);
    printf("%s",flag);
}
